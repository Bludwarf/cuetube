var minecraft = new Disc(_.extend(new cuesheet.CueSheet(), {"catalog":null,"cdTextFile":null,"files":[{"name":"https://www.youtube.com/watch?v=Dg0IjOzopYU","type":"MP3","tracks":[{"number":1,"type":"AUDIO","title":"Key (Nuance 1)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]},{"number":2,"type":"AUDIO","title":"Subwoofer Lullaby (Hal 1)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":1,"sec":4,"frame":0}}]},{"number":3,"type":"AUDIO","title":"Living Mice (Hal 2)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":4,"sec":40,"frame":0}}]},{"number":4,"type":"AUDIO","title":"Haggstrom (Hal 3)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":7,"sec":30,"frame":0}}]},{"number":5,"type":"AUDIO","title":"Minecraft (Calm 1)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":10,"sec":53,"frame":0}}]},{"number":6,"type":"AUDIO","title":"Oxygene (Nuance 2)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":15,"sec":8,"frame":0}}]},{"number":7,"type":"AUDIO","title":"Mice on Venus (Piano 3)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":16,"sec":14,"frame":0}}]},{"number":8,"type":"AUDIO","title":"Dry Hands (Piano 1)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":21,"sec":8,"frame":0}}]},{"number":9,"type":"AUDIO","title":"Wet Hands (Piano 2)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":22,"sec":4,"frame":0}}]},{"number":10,"type":"AUDIO","title":"Clark (Calm 2)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":23,"sec":34,"frame":0}}]},{"number":11,"type":"AUDIO","title":"Sweden (Calm 3)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":26,"sec":46,"frame":0}}]},{"number":12,"type":"AUDIO","title":"Danny (Hal 4)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":30,"sec":21,"frame":0}}]},{"number":13,"type":"AUDIO","title":"Biome Fest (Creative 1)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":34,"sec":38,"frame":0}}]},{"number":14,"type":"AUDIO","title":"Blind Spots (Creative 2)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":40,"sec":58,"frame":0}}]},{"number":15,"type":"AUDIO","title":"Haunt Muskie (Creative 3)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":46,"sec":34,"frame":0}}]},{"number":16,"type":"AUDIO","title":"Aria Math (Creative 4)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":52,"sec":32,"frame":0}}]},{"number":17,"type":"AUDIO","title":"Dreiton (Creative 5)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":57,"sec":54,"frame":0}}]},{"number":18,"type":"AUDIO","title":"Taswell (Creative 6)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":66,"sec":5,"frame":0}}]},{"number":19,"type":"AUDIO","title":"Mutation (Menu 1)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":74,"sec":32,"frame":0}}]},{"number":20,"type":"AUDIO","title":"Moog City 2 (Menu 2)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":77,"sec":46,"frame":0}}]},{"number":21,"type":"AUDIO","title":"Beginning 2 (Menu 3)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":80,"sec":52,"frame":0}}]},{"number":22,"type":"AUDIO","title":"Floating Trees (Menu 4)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":83,"sec":56,"frame":0}}]},{"number":23,"type":"AUDIO","title":"Concrete Halls (Nether 1)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":88,"sec":1,"frame":0}}]},{"number":24,"type":"AUDIO","title":"Dead Voxel (Nether 2)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":92,"sec":22,"frame":0}}]},{"number":25,"type":"AUDIO","title":"Warmth (Nether 3)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":97,"sec":24,"frame":0}}]},{"number":26,"type":"AUDIO","title":"Ballad of the Cats (Nether 4)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":101,"sec":28,"frame":0}}]},{"number":27,"type":"AUDIO","title":"Boss","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":106,"sec":3,"frame":0}}]},{"number":28,"type":"AUDIO","title":"End","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":111,"sec":48,"frame":0}}]}]}],"performer":"Luigi","songWriter":null,"title":"Minecraft FULL SOUNDTRACK (2016)","rems":null,"rem":["COMMENT \"http://minecraft.gamepedia.com/Music\""]}));
var minecraftFile = minecraft.files[0];
var minecraftTrack = minecraftFile.tracks[0];

var age2 = new Disc(_.extend(new cuesheet.CueSheet(), {"catalog":null,"cdTextFile":null,"files":[{"name":"https://www.youtube.com/watch?v=RRtlWfi6jiM","type":"MP3","tracks":[{"number":1,"type":"AUDIO","title":"Main Theme","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=Rxbcp2AK-2Y&list=PL1800E1EFCA1EABE3&index=2","type":"MP3","tracks":[{"number":2,"type":"AUDIO","title":"Track 1 : Shamburger","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=FXp--cIRR2c&list=PL1800E1EFCA1EABE3&index=3","type":"MP3","tracks":[{"number":3,"type":"AUDIO","title":"Track 2 : I Will Beat On Your Behind","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=wsrvDc8ikpM&list=PL1800E1EFCA1EABE3&index=4","type":"MP3","tracks":[{"number":4,"type":"AUDIO","title":"Track 3 : Drizzle (Firelight Smoove Mix)","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=NDcZXEMF84k&list=PL1800E1EFCA1EABE3&index=5","type":"MP3","tracks":[{"number":5,"type":"AUDIO","title":"Track 4 : Machina del Diablo","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=09hkbF0AFwk&list=PL1800E1EFCA1EABE3&index=6","type":"MP3","tracks":[{"number":6,"type":"AUDIO","title":"Track 5 : T Station","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=KtrvTntcBUE&list=PL1800E1EFCA1EABE3&index=7","type":"MP3","tracks":[{"number":7,"type":"AUDIO","title":"Track 6 : Bass Bag","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=1T0Yi4x5_8Q&list=PL1800E1EFCA1EABE3&index=8","type":"MP3","tracks":[{"number":8,"type":"AUDIO","title":"Track 7 : Ride, Lawrence, Ride!","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=PkOC5BnnXwU&list=PL1800E1EFCA1EABE3&index=9","type":"MP3","tracks":[{"number":9,"type":"AUDIO","title":"Track 8 : Smells Like Crickets, Tastes Like Chicken","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=pKxWHEiuIbI&list=PL1800E1EFCA1EABE3&index=10","type":"MP3","tracks":[{"number":10,"type":"AUDIO","title":"Track 9 : Operation Monkey","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=iOhW_d90Cfw&list=PL1800E1EFCA1EABE3&index=11","type":"MP3","tracks":[{"number":11,"type":"AUDIO","title":"Track 10 : Tazer","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=xcxooGUBkYU&list=PL1800E1EFCA1EABE3&index=12","type":"MP3","tracks":[{"number":12,"type":"AUDIO","title":"Scenario Success 1","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=O4pN6EqUN4E&list=PL1800E1EFCA1EABE3&index=13","type":"MP3","tracks":[{"number":13,"type":"AUDIO","title":"Scenario Success 2","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=zgOIFjNqcNs&list=PL1800E1EFCA1EABE3&index=14","type":"MP3","tracks":[{"number":14,"type":"AUDIO","title":"Scenario Failure","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]},{"name":"https://www.youtube.com/watch?v=FtV5CcJqKMg","type":"MP3","tracks":[{"number":15,"type":"AUDIO","title":"Credits","flags":null,"isrc":null,"performer":null,"songWriter":null,"pregap":null,"postgap":null,"indexes":[{"number":1,"time":{"min":0,"sec":0,"frame":0}}]}]}],"performer":"Gamegroove","songWriter":"Stephen Rippy, Kevin McMullan","title":"Age of Empires 2: Age of Kings","rems":null,"rem":["COMMENT \"Playlist YouTube : https://www.youtube.com/watch?v=FXp--cIRR2c&index=3&list=PL1800E1EFCA1EABE3\""]}));

// Données récupérées du player YouTube
minecraftFile.duration = 7613.001;

function loadDisc(jsonFile) {
  const json = readJSON(jsonFile);
  return new Disc(_.extend(new cuesheet.CueSheet(), json));
}

describe("Disc mono vidéo", function() {
  
  it("has properties of cuesheet.CueSheet", function() {
    expect(minecraft.title).toBe("Minecraft FULL SOUNDTRACK (2016)");
    expect(minecraft.performer).toBe("Luigi");
  });
  
  it("has cuesheet", function() {
    expect(minecraft.cuesheet).not.toBeNull();
  });
  
  it("has files", function() {
    expect(minecraft.files.length).toBe(1);
  });
  
  it("has videoId", function() {
    expect(minecraft.videoId).toBe("Dg0IjOzopYU");
  });
  
  it("has tracks", function() {
    expect(minecraft.tracks.length).toBe(28);
  });
  
  it("is enabled", function() {
    expect(minecraft.enabled).toBe(true);
  });
  
  it("is playable", function() {
    var disc = new Disc();
    expect(disc.playable).toBe(false);
    
    disc.files = [new Disc.File(disc)];
    disc.files[0].tracks = [new Disc.Track(disc.files[0])];
    var track = disc.files[0].tracks[0];
    track.enabled = false;
    expect(disc.playable).toBe(false);
    
    track.enabled = true;
    expect(disc.playable).toBe(true);
    
    disc.files[0].tracks.push(new Disc.Track(disc.files[0]));
    var track2 = disc.files[0].tracks[1];
    
    track.enabled = false;
    track2.enabled = false;
    expect(disc.playable).toBe(false);
    
    track.enabled = false;
    track2.enabled = true;
    expect(disc.playable).toBe(true);
    
    track.enabled = true;
    track2.enabled = false;
    expect(disc.playable).toBe(true);
  });

  it("has disabled tracks", function() {
      var disc = new Disc();

      let file = disc.newFile();
      let track1 = file.newTrack();
      let track2 = file.newTrack();

      expect(disc.disabledTracks.length).toBe(0);

      track1.enabled = false;
      expect(track1.number).toBe(1);
      expect(disc.disabledTracks.map(function(track) {return track.number})).toEqual([1]);
  });
});

describe("Disc multi vidéo", function() {
  
  it("has properties of cuesheet.CueSheet", function() {
    expect(age2.title).toBe("Age of Empires 2: Age of Kings");
    expect(age2.performer).toBe("Gamegroove");
  });
  
  it("has cuesheet", function() {
    expect(age2.cuesheet).not.toBeNull();
  });
  
  it("has files", function() {
    expect(age2.files.length).toBe(15);
  });
  
  it("has videoId", function() {
    expect(age2.videoId).toBe("RRtlWfi6jiM");
  });
  
  it("has tracks", function() {
    expect(age2.tracks.length).toBe(15);
  });
  
  it("is enabled", function() {
    expect(age2.enabled).toBe(true);
  });
  
  it("has newFile constructor + File.newTrack", function() {
    var disc = new Disc();
    
    var file = disc.newFile();
    expect(file.disc).toEqual(disc);
    expect(file.index).toBe(0);
    
    var file2 = disc.newFile();
    expect(file2.disc).toEqual(disc);
    expect(file2.index).toBe(1);
    
    var track1 = file.newTrack();
    track1.title = 'Track 1';
    expect(track1.title).toBe('Track 1');
    expect(track1.disc).toEqual(disc);
    expect(track1.file).toEqual(file);
    expect(track1.index).toBe(0);
    
    var track2 = file.newTrack();
    track2.title = 'Track 2';
    expect(track2.title).toBe('Track 2');
    expect(track2.disc).toEqual(disc);
    expect(track2.file).toEqual(file);
    expect(track2.index).toBe(1);
    
    var track3 = file2.newTrack();
    track3.title = 'Track 3';
    expect(track3.title).toBe('Track 3');
    expect(track3.disc).toEqual(disc);
    expect(track3.file).toEqual(file2);
    expect(track3.index).toBe(0);
    
    expect(disc.tracks).toEqual([track1, track2, track3]);
  });
  
  it("is playable", function() {
    var disc = new Disc();
    
    var file1 = disc.newFile();
    var track1 = file1.newTrack();
    var track2 = file1.newTrack();
    
    var file2 = disc.newFile();
    var track3 = file2.newTrack();
    
    expect(disc.playable).toBe(true);
    
    disc.enabled = false
    expect(disc.playable).toBe(false);
    
    disc.enabled = true
    expect(disc.playable).toBe(true);
    
    track3.enabled = false;
    expect(disc.playable).toBe(true);
    
    track1.enabled = false;
    track3.enabled = true;
    expect(disc.playable).toBe(true);
    
    track3.enabled = false;
    expect(disc.playable).toBe(true);
    
    track2.enabled = false;
    expect(disc.playable).toBe(false);
  });
});

describe("Disc.File", function() {
  
  var file = minecraftFile;
  
  it("has cuesheetFile", function() {
    expect(file.cuesheetFile).not.toBeNull();
  });
  
  it("has properties of cuesheet.File", function() {
    expect(minecraftFile.name).toBe("https://www.youtube.com/watch?v=Dg0IjOzopYU");
    expect(file.type).toBe("MP3");
  });
  
  it("has tracks", function() {
    expect(file.tracks).not.toBeNull();
    expect(file.tracks.size).toBe(minecraft.tracks.size);
    expect(file.tracks[0]).toBe(minecraft.tracks[0]);
    expect(file.tracks[file.tracks.size-1]).toBe(minecraft.tracks[file.tracks.size-1]);
  });
  
  it("has videoId", function() {
    expect(file.videoId).toBe("Dg0IjOzopYU");
  });
  
  it("has index", function() {
    expect(file.index).toBe(0);
  });

  it("should find track at time in multitrack video", function() {
    const file = minecraft.files[0];
    let track;

    // Par défaut => 1ère
    track = file.getTrackAt(0);
    expect(track).not.toBeNull();
    expect(track.title).toBe("Key (Nuance 1)");

    track = file.getTrackAt(1*3600 + 14*60 + 2);
    expect(track).not.toBeNull();
    expect(track.title).toBe("Taswell (Creative 6)");

    // Par défaut => dernière
    track = file.getTrackAt(3*3600);
    expect(track).not.toBeNull();
    expect(track.title).toBe("End");
  });

  it("should find track at time in multi video disc", function() {
    const file = age2.files[0];
    let track, trackBis;

    // Par défaut => 1ère
    track = file.getTrackAt(0);
    expect(track).not.toBeNull();
    expect(track.title).toBe("Main Theme");

    trackBis = file.getTrackAt(50);
    expect(trackBis).toBe(track);

    // Par défaut => dernière
    trackBis = file.getTrackAt(3*3600);
    expect(trackBis).toBe(track);
  });
  
});

describe("Disc.Track", function() {
  
  var file = minecraftFile;
  var track = minecraftTrack;
  
  it("has properties of cuesheet.Track", function() {
    expect(track.number).toBe(1);
    expect(track.title).toBe("Key (Nuance 1)");
    
    // par défaut on a toujours un index
    expect(track.indexes).toEqual([{
    	"number": 1,
    	"time": {
    		"min": 0,
    		"sec": 0,
    		"frame": 0
    	}
    }]);
  });
  
  it("has index", function() {
    expect(track.index).toBe(0);
  });
  
  it("has file", function() {
    expect(track.file).toEqual(file);
  });
  
  it("has disc", function() {
    expect(track.disc).toEqual(minecraft);
  });
  
  it("has startSeconds", function() {
    expect(track.startSeconds).toEqual(0);
    expect(file.tracks[1].startSeconds).toEqual(64); // 01:04
    expect(file.tracks[27].startSeconds).toEqual(111*60+48); // 1:51:48 -> 6708 s.
  });
  
  it("has next", function() {
    expect(file.tracks[0].next).toEqual(file.tracks[1]);
    //expect(file.tracks[26].next).toEqual(file.tracks[1]);
  });
  
  it("has endSeconds", function() {
    expect(track.endSeconds).toEqual(64);
    expect(file.tracks[27].endSeconds).toEqual(7613.001);
  });

  // Disque dont les pistes ne sont pas ordonnés par startSeconds
  it("has endSeconds even on tracks non ordered", function() {
    let disc = loadDisc('samples/LeGrandBleu-cd2-unordered.json');
    let track = disc.tracks[6];
    let nextInTime = disc.tracks[2]; // next = Watergames

    // verif de la propriété indexInTime
    expect(track.indexInTime).toBe(12);
    expect(nextInTime.indexInTime).toBe(13);

    expect(track.endSeconds).toEqual(nextInTime.startSeconds);
  });
  
});